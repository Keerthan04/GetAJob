name: Deploy Backend to Azure VM

on:
  push:
    branches:
      - main  # Triggers deployment on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 4.186.56.114 >> ~/.ssh/known_hosts

    - name: Deploy Backend to Azure VM
      run: |
        ssh -i ~/.ssh/id_rsa keerthanvm@4.186.56.114 << 'EOF'
            cd /home/keerthanvm/GetAJob/backend || exit 1  # Ensure we're in backend
            
            # Ensure repo exists
            if [ ! -d ".git" ]; then
              git clone https://github.com/Keerthan04/GetAJob.git .
            fi

            git pull origin main  # Pull latest changes

            npm install  # Install dependencies locally
            npm install --save-dev prisma  # Fix Prisma permission issue
            npx prisma migrate deploy  # Run database migrations
            npm run build  # Compile TypeScript
            
            # Inject .env from GitHub Secrets safely
            printf "%s" "${{ secrets.ENV_FILE }}" > .env

            # Find the correct build file and restart with PM2
            if [ -f "dist/server.js" ]; then
              pm2 restart dist/server.js --name backend
            elif [ -f "dist/index.js" ]; then
              pm2 restart dist/index.js --name backend
            else
              echo "⚠️ No valid build file found in dist/"
              exit 1
            fi
        EOF
