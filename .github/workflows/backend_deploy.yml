name: Deploy Backend to Azure VM

on:
  push:
    branches:
      - main  # Triggers deployment on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 4.186.56.114 >> ~/.ssh/known_hosts

    - name: Deploy Backend to Azure VM
      run: |
        ssh -i ~/.ssh/id_rsa keerthanvm@4.186.56.114 << 'EOF'
            cd /home/keerthanvm/GetAJob/backend || exit 1  # Change to backend directory

            git pull origin main  # Pull latest changes

            npm install  # Install dependencies
            npm install -g prisma  # Ensure Prisma is installed
            npx prisma migrate deploy  # Apply database migrations
            npm run build  # Compile TypeScript

            # Inject .env from GitHub Secrets safely(for multi line so printf)
            printf "%s" "${{ secrets.ENV_FILE }}" > .env


            pm2 restart dist/index.js --name backend  # Restart backend with PM2
        EOF
